<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GasMonitor Pro - Controle Remoto</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2E7D32;
            --accent: #8BC34A;
            --error: #f44336;
            --warning: #FFC107;
            --dark: #121212;
            --darker: #0A0A0A;
            --light: #f5f5f5;
            --text-primary: #FFFFFF;
            --text-secondary: #CCCCCC;
            --neon-green: #00FF00;
            --neon-blue: #00FFFF;
            --neon-pink: #FF00FF;
            --grid-line: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            touch-action: manipulation;
        }

        /* Estilos da Tela de Login */
        .login-container {
            width: 100%;
            max-width: 400px;
            background: rgba(18, 18, 18, 0.9);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform-style: preserve-3d;
            perspective: 1000px;
            transition: all 0.5s ease;
        }

        @media (max-width: 480px) {
            .login-container {
                width: 95%;
                padding: 15px;
            }
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(0, 255, 0, 0.1), transparent);
            transform: rotate(45deg);
            animation: shine 6s infinite;
            z-index: -1;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .logo {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
            color: var(--neon-green);
            text-shadow: 0 0 15px var(--neon-green);
            animation: pulse 2s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0.8; }
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 1px;
        }

        .form-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--neon-green);
            box-shadow: 0 0 0 2px rgba(0, 255, 0, 0.2);
            background: rgba(0, 255, 0, 0.05);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .form-footer {
            margin-top: 15px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .form-footer a {
            color: var(--neon-blue);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .form-footer a:hover {
            color: var(--neon-green);
            text-decoration: underline;
        }

        .error-message {
            color: var(--error);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .form-switch {
            text-align: center;
            margin-top: 15px;
        }

        .form-switch a {
            color: var(--neon-blue);
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .form-switch a:hover {
            color: var(--neon-green);
            text-decoration: underline;
        }

        /* Animated background elements */
        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 255, 0, 0.05);
            filter: blur(60px);
            animation: float 15s infinite ease-in-out;
        }

        .circle-1 {
            width: 300px;
            height: 300px;
            top: -100px;
            left: -100px;
            animation-delay: 0s;
        }

        .circle-2 {
            width: 200px;
            height: 200px;
            bottom: -50px;
            right: -50px;
            background: rgba(0, 255, 255, 0.05);
            animation-delay: 3s;
        }

        .circle-3 {
            width: 150px;
            height: 150px;
            top: 50%;
            left: 50%;
            background: rgba(255, 0, 255, 0.05);
            animation-delay: 6s;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(50px, 50px) rotate(180deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }

        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--neon-green);
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Password toggle */
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 40px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .password-toggle:hover {
            color: var(--neon-green);
        }

        /* Form transitions */
        .form-container {
            transition: all 0.5s ease;
            transform-origin: top;
        }

        .form-container.hidden {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            pointer-events: none;
            position: absolute;
            width: 100%;
        }

        /* Status messages */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
        }

        .status-normal {
            background: rgba(0, 255, 0, 0.1);
            color: var(--neon-green);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .indicator-connected {
            background: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green);
        }

        .indicator-disconnected {
            background: var(--error);
        }

        .indicator-connecting {
            background: var(--warning);
            animation: pulse 1.5s infinite alternate;
        }

        .hidden {
            display: none;
        }

        /* Estilos da Página Principal (Monitor) */
        .main-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.3s ease-out;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.8rem;
            }
        }

        .logo-small {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-small .logo-icon {
            font-size: 1.8rem;
            color: var(--neon-green);
            text-shadow: 0 0 10px var(--neon-green);
        }

        .logo-small .logo-text {
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.8rem;
            }
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (min-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
        }

        .panel {
            background: var(--darker);
            border-radius: 8px;
            padding: 1.2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .panel {
                padding: 1rem;
            }
        }

        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 255, 0, 0.2);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--grid-line);
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--neon-green);
        }

        @media (max-width: 768px) {
            .panel-title {
                font-size: 1rem;
            }
        }

        .connection-panel {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        input {
            flex: 1;
            min-width: 150px;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--grid-line);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--neon-green);
            box-shadow: 0 0 0 2px rgba(0, 255, 0, 0.2);
        }

        button {
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            button {
                padding: 0.7rem 1rem;
                font-size: 0.85rem;
            }
        }

        .btn-connect {
            background: var(--primary);
            color: white;
        }

        .btn-connect:hover {
            background: var(--accent);
            transform: translateY(-2px);
        }

        .btn-connect:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-valve {
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .btn-valve {
                padding: 0.7rem 1rem;
                font-size: 0.85rem;
            }
        }

        .btn-valve-open {
            background: var(--error);
            color: white;
        }

        .btn-valve-closed {
            background: var(--primary);
            color: white;
        }

        .valve-control {
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        #valveStatusText {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .gas-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 1.5rem 0;
        }

        .gas-value {
            font-size: 3rem;
            font-weight: bold;
            margin: 0.8rem 0;
            text-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .gas-value {
                font-size: 2.5rem;
            }
        }

        .gas-unit {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .gas-status {
            padding: 0.5rem 1.2rem;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-normal {
            background: rgba(0, 255, 0, 0.1);
            color: var(--neon-green);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning);
            animation: pulse 1.5s infinite alternate;
        }

        .status-danger {
            background: rgba(255, 0, 0, 0.1);
            color: var(--error);
            animation: pulse 1s infinite alternate;
        }

        .chart-container {
            height: 300px;
            width: 100%;
            position: relative;
            margin: 1.2rem 0;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
        }

        .chart-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .chart-btn {
            padding: 5px 8px;
            background: var(--darker);
            border: 1px solid var(--grid-line);
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }

        .chart-btn:hover {
            background: rgba(0, 255, 0, 0.1);
            border-color: var(--neon-green);
        }

        .waveform-container {
            height: 150px;
            width: 100%;
            position: relative;
            margin: 1.2rem 0;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }

        @media (max-width: 768px) {
            .waveform-container {
                height: 120px;
            }
        }

        .waveform-bar {
            background: var(--neon-green);
            flex: 1;
            min-width: 3px;
            border-radius: 2px 2px 0 0;
            transition: height 0.1s ease;
            box-shadow: 0 0 5px var(--neon-green);
        }

        .waveform-bar.warning {
            background: var(--warning);
            box-shadow: 0 0 5px var(--warning);
        }

        .waveform-bar.danger {
            background: var(--error);
            box-shadow: 0 0 5px var(--error);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            border-radius: 6px;
            margin-top: 1.2rem;
        }

        .status-connected {
            background: rgba(0, 255, 0, 0.1);
            color: var(--neon-green);
        }

        .status-disconnected {
            background: rgba(255, 0, 0, 0.1);
            color: var(--error);
        }

        .status-connecting {
            background: rgba(255, 255, 0, 0.1);
            color: var(--warning);
            animation: pulse 1.5s infinite alternate;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .indicator-connected {
            background: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green);
        }

        .indicator-disconnected {
            background: var(--error);
        }

        .indicator-connecting {
            background: var(--warning);
            animation: pulse 1.5s infinite alternate;
        }

        .history-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
            scrollbar-width: thin;
            scrollbar-color: var(--neon-green) var(--darker);
        }

        .history-container::-webkit-scrollbar {
            width: 6px;
        }

        .history-container::-webkit-scrollbar-track {
            background: var(--darker);
        }

        .history-container::-webkit-scrollbar-thumb {
            background-color: var(--neon-green);
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            table {
                font-size: 0.8rem;
            }
        }

        th, td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--grid-line);
        }

        @media (max-width: 768px) {
            th, td {
                padding: 0.6rem;
            }
        }

        th {
            position: sticky;
            top: 0;
            background: var(--darker);
            color: var(--neon-green);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
        }

        tr:hover {
            background: rgba(0, 255, 0, 0.05);
        }

        .danger-row {
            background: rgba(255, 0, 0, 0.1) !important;
        }

        .warning-row {
            background: rgba(255, 193, 7, 0.1) !important;
        }

        .toast {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease-out;
            max-width: 90%;
            text-align: center;
        }

        @keyframes slideIn {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--neon-green);
            animation: spin 1s linear infinite;
        }

        .tab-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.2rem;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab {
            padding: 0.6rem 1.2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .tab {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
        }

        .tab.active {
            background: var(--neon-green);
            color: var(--dark);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.2rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1.2rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .stat-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .progress-container {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 0.8rem;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
            transition: width 0.5s ease;
        }

        .export-btn {
            background: var(--neon-blue);
            color: var(--dark);
            font-weight: 600;
            margin-top: 1.2rem;
        }

        .export-btn:hover {
            background: var(--neon-pink);
            color: white;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 1.2rem;
            margin-right: 15px;
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
        }

        .flame-monitoring-panel {
            margin-top: 1.5rem;
            background: rgba(255, 100, 100, 0.05);
            border-radius: 8px;
            padding: 1.2rem;
            border-top: 1px solid rgba(255, 100, 100, 0.2);
        }

        .flame-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.2rem;
            margin: 1.2rem 0;
        }

        @media (max-width: 480px) {
            .flame-stats {
                grid-template-columns: 1fr;
            }
        }

        .flame-stat {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 0.8rem;
            text-align: center;
        }

        .flame-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--neon-green);
            margin: 0.5rem 0;
        }

        @media (max-width: 768px) {
            .flame-stat-value {
                font-size: 1.8rem;
            }
        }

        .flame-stat-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .flame-progress-container {
            margin: 1.2rem 0;
        }

        .flame-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .flame-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-blue));
            transition: width 0.5s ease;
        }

        .flame-progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .flame-alert {
            background: rgba(255, 0, 0, 0.1);
            padding: 0.8rem;
            border-radius: 5px;
            margin-top: 1rem;
            border-left: 3px solid var(--error);
            display: none;
            font-size: 0.85rem;
        }

        .flame-history-chart {
            height: 250px;
            margin-top: 1.5rem;
        }

        @media (max-width: 768px) {
            .flame-history-chart {
                height: 200px;
            }
        }

        .flame-settings {
            margin-top: 1.2rem;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .flame-settings-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .flame-settings-label {
            width: 180px;
            margin-right: 0.8rem;
            font-size: 0.85rem;
        }

        @media (max-width: 480px) {
            .flame-settings-label {
                width: 100%;
                margin-right: 0;
            }
        }

        .gps-container {
            margin-top: 1rem;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .gps-container a {
            color: var(--neon-blue);
            text-decoration: none;
        }

        .gps-container a:hover {
            text-decoration: underline;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .user-dropdown {
            position: absolute;
            right: 0;
            top: 45px;
            background: var(--darker);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            width: 180px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 10px 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .user-dropdown-item:hover {
            background: rgba(0, 255, 0, 0.1);
        }

        .user-dropdown-divider {
            height: 1px;
            background: var(--grid-line);
            margin: 5px 0;
        }

        .status-summary {
            display: flex;
            justify-content: space-around;
            margin: 1rem 0;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
            min-width: 60px;
        }

        .status-icon {
            font-size: 1.3rem;
            margin-bottom: 0.3rem;
        }

        /* Melhorias para telas muito pequenas */
        @media (max-width: 360px) {
            .panel-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .gas-status {
                align-self: flex-start;
            }
            
            .valve-control {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .flame-settings-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .flame-settings-label {
                margin-bottom: 0.3rem;
            }
        }

        /* Melhorias para orientação paisagem em dispositivos móveis */
        @media (max-height: 500px) and (orientation: landscape) {
            .history-container {
                max-height: 200px;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .flame-history-chart {
                height: 180px;
            }
        }
    </style>
</head>
<body>
    <!-- Background elements -->
    <div class="bg-circle circle-1"></div>
    <div class="bg-circle circle-2"></div>
    <div class="bg-circle circle-3"></div>

    <!-- Tela de Login -->
    <div class="login-container" id="loginScreen">
        <div class="logo">
            <div class="logo-icon">⚠️</div>
            <div class="logo-text">GasMonitor Pro</div>
        </div>

        <!-- Login Form -->
        <div class="form-container" id="loginForm">
            <h2 class="form-title">Login</h2>
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="loginEmail">E-mail</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="seu@email.com" required>
                    <div class="error-message" id="loginEmailError">E-mail inválido</div>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="••••••••" required>
                    <i class="password-toggle" id="toggleLoginPassword">👁️</i>
                    <div class="error-message" id="loginPasswordError">Senha incorreta</div>
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <span>Entrar</span>
                    <div class="spinner" id="loginSpinner"></div>
                </button>
            </form>
            <div class="form-footer">
                <a href="#" id="forgotPasswordLink">Esqueceu sua senha?</a>
                <p>Não tem uma conta? <a href="#" id="showRegisterLink">Cadastre-se</a></p>
            </div>
        </div>

        <!-- Register Form -->
        <div class="form-container hidden" id="registerForm">
            <h2 class="form-title">Criar Conta</h2>
            <form id="registerFormElement">
                <div class="form-group">
                    <label for="registerName">Nome Completo</label>
                    <input type="text" id="registerName" class="form-control" placeholder="Seu nome" required>
                    <div class="error-message" id="registerNameError">Nome é obrigatório</div>
                </div>
                <div class="form-group">
                    <label for="registerEmail">E-mail</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="seu@email.com" required>
                    <div class="error-message" id="registerEmailError">E-mail inválido</div>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Senha</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="••••••••" required minlength="8">
                    <i class="password-toggle" id="toggleRegisterPassword">👁️</i>
                    <div class="error-message" id="registerPasswordError">Senha deve ter pelo menos 8 caracteres</div>
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirmar Senha</label>
                    <input type="password" id="registerConfirmPassword" class="form-control" placeholder="••••••••" required>
                    <i class="password-toggle" id="toggleRegisterConfirmPassword">👁️</i>
                    <div class="error-message" id="registerConfirmPasswordError">As senhas não coincidem</div>
                </div>
                <button type="submit" class="btn btn-primary" id="registerBtn">
                    <span>Cadastrar</span>
                    <div class="spinner" id="registerSpinner"></div>
                </button>
            </form>
            <div class="form-footer">
                <p>Já tem uma conta? <a href="#" id="showLoginLink">Faça login</a></p>
            </div>
        </div>

        <!-- Forgot Password Form -->
        <div class="form-container hidden" id="forgotPasswordForm">
            <h2 class="form-title">Recuperar Senha</h2>
            <form id="forgotPasswordFormElement">
                <div class="form-group">
                    <label for="forgotEmail">E-mail</label>
                    <input type="email" id="forgotEmail" class="form-control" placeholder="seu@email.com" required>
                    <div class="error-message" id="forgotEmailError">E-mail inválido</div>
                </div>
                <button type="submit" class="btn btn-primary" id="forgotPasswordBtn">
                    <span>Enviar Link</span>
                    <div class="spinner" id="forgotPasswordSpinner"></div>
                </button>
            </form>
            <div class="form-footer">
                <p>Lembrou sua senha? <a href="#" id="showLoginLink2">Faça login</a></p>
            </div>
        </div>

        <!-- Reset Password Form -->
        <div class="form-container hidden" id="resetPasswordForm">
            <h2 class="form-title">Redefinir Senha</h2>
            
            <div id="resetSuccessMessage" class="connection-status status-normal hidden">
                <div class="status-indicator indicator-connected"></div>
                <span>Senha redefinida com sucesso!</span>
            </div>

            <form id="resetPasswordFormElement">
                <input type="hidden" id="resetToken">
                
                <div class="form-group">
                    <label for="resetNewPassword">Nova Senha</label>
                    <input type="password" id="resetNewPassword" class="form-control" placeholder="••••••••" required minlength="8">
                    <i class="password-toggle" id="toggleResetPassword">👁️</i>
                    <div class="error-message" id="resetPasswordError"></div>
                </div>
                
                <div class="form-group">
                    <label for="resetConfirmPassword">Confirmar Nova Senha</label>
                    <input type="password" id="resetConfirmPassword" class="form-control" placeholder="••••••••" required>
                    <i class="password-toggle" id="toggleResetConfirmPassword">👁️</i>
                    <div class="error-message" id="resetConfirmPasswordError"></div>
                </div>
                
                <button type="submit" class="btn btn-primary" id="resetPasswordBtn">
                    <span>Redefinir Senha</span>
                    <div class="spinner" id="resetPasswordSpinner"></div>
                </button>
            </form>
            
            <div class="form-footer">
                <p>Lembrou sua senha? <a href="#" id="showLoginLink3">Faça login</a></p>
            </div>
        </div>
    </div>

    <!-- Página Principal (Monitor) -->
    <div class="main-container" id="mainScreen">
        <div class="header">
            <div class="logo-small">
                <div class="logo-icon">⚠️</div>
                <div class="logo-text">GasMonitor Pro</div>
            </div>
            <div class="user-menu">
                <div class="notification-bell" id="notificationBell">
                    🔔
                    <span class="notification-count" id="alertCount">0</span>
                </div>
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-item" id="userName">Usuário</div>
                    <div class="user-dropdown-item" id="userEmail">email@exemplo.com</div>
                    <div class="user-dropdown-divider"></div>
                    <div class="user-dropdown-item" id="profileBtn">Meu Perfil</div>
                    <div class="user-dropdown-item" id="settingsBtn">Configurações</div>
                    <div class="user-dropdown-divider"></div>
                    <div class="user-dropdown-item" id="logoutBtn">Sair</div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="dashboard">
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">Monitoramento em Tempo Real</div>
                        <div class="gas-status status-normal" id="gasStatus">NORMAL</div>
                    </div>

                    <div class="connection-status" id="connectionStatus">
                        <div class="status-indicator indicator-disconnected"></div>
                        <span>Conectando ao dispositivo...</span>
                    </div>

                    <div class="status-summary">
                        <div class="status-item">
                            <span class="status-icon" id="currentStatusIcon">✅</span>
                            <span>Status Atual</span>
                        </div>
                        <div class="status-item">
                            <span class="status-icon" id="readingsCount">0</span>
                            <span>Leituras</span>
                        </div>
                        <div class="status-item">
                            <span class="status-icon" id="uptimeIcon">⏱️</span>
                            <span id="uptimeText">00:00:00</span>
                        </div>
                        <div class="status-item">
                            <span class="status-icon" id="connectionTypeIcon">📶</span>
                            <span id="connectionTypeText">WiFi</span>
                        </div>
                    </div>

                    <div class="gas-display">
                        <div class="gas-value" id="gasValue">--</div>
                        <div class="gas-unit">ppm</div>
                    </div>

                    <div class="valve-control">
                        <button id="valveControlBtn" class="btn-valve btn-valve-closed">
                            <a href="https://v0-criar-pasta.vercel.app/">controlar valvula</a>
                        </button>
                      
                    </div>

                    <div class="chart-container">
                        <canvas id="gasChart"></canvas>
                        <div class="chart-actions">
                            <button class="chart-btn" id="zoomInBtn">➕ Zoom In</button>
                            <button class="chart-btn" id="zoomOutBtn">➖ Zoom Out</button>
                            <button class="chart-btn" id="resetZoomBtn">🔍 Resetar Zoom</button>
                        </div>
                    </div>

                    <div class="waveform-container" id="waveformContainer">
                        <!-- Barras serão adicionadas dinamicamente -->
                    </div>

                    <div class="alarm-controls" id="alarmControls">
                        <button class="mute-alarm chart-btn" id="muteAlarmBtn">
                            🔇 Silenciar Alarme
                        </button>
                    </div>

                    <div class="gps-container">
                        <div class="panel-title">Localização do Sensor</div>
                        <div id="gpsLocation">Aguardando localização...</div>
                    </div>
                </div>

                <div class="panel flame-monitoring-panel">
                    <div class="panel-header">
                        <div class="panel-title">Monitoramento do Fogão</div>
                        <div class="gas-status" id="flameStateStatus">DESLIGADO</div>
                    </div>

                    <div class="flame-stats">
                        <div class="flame-stat">
                            <div class="flame-stat-title">Sessão Atual</div>
                            <div class="flame-stat-value" id="currentFlameTime">00:00:00</div>
                            <div class="flame-stat-title">Tempo contínuo</div>
                        </div>
                        <div class="flame-stat">
                            <div class="flame-stat-title">Total Hoje</div>
                            <div class="flame-stat-value" id="totalFlameTime">00:00:00</div>
                            <div class="flame-stat-title">Tempo acumulado</div>
                        </div>
                    </div>

                    <div class="flame-progress-container">
                        <div class="panel-title">Progresso Diário</div>
                        <div class="flame-progress-bar">
                            <div class="flame-progress" id="flameProgress"></div>
                        </div>
                        <div class="flame-progress-labels">
                            <span>0h</span>
                            <span id="dailyLimitLabel">8h máximo</span>
                        </div>
                    </div>

                    <div class="flame-alert" id="flameAlert">
                        <strong>ALERTA:</strong> Fogão ligado por mais de <span id="alertThresholdMinutes">60</span> minutos continuamente!
                    </div>

                    <div class="flame-settings">
                        <h3>Configurações de Alerta</h3>
                        <div class="flame-settings-row">
                            <label class="flame-settings-label" for="maxUsageInput">Alerta após (minutos):</label>
                            <input type="number" id="maxUsageInput" value="60" min="1">
                            <button class="chart-btn" id="saveFlameSettings">Salvar</button>
                        </div>
                        <div class="flame-settings-row">
                            <label class="flame-settings-label" for="dailyMaxInput">Limite diário (horas):</label>
                            <input type="number" id="dailyMaxInput" value="8" min="1">
                        </div>
                        <div class="flame-settings-row">
                            <button class="chart-btn" id="resetFlameTimeBtn">Resetar Tempo Diário</button>
                        </div>
                    </div>

                    <div class="panel-title" style="margin-top: 1.5rem;">Histórico de Uso</div>
                    <div class="chart-container flame-history-chart">
                        <canvas id="flameHistoryChart"></canvas>
                    </div>

                    <button class="export-btn" id="exportFlameData" style="margin-top: 1.5rem;">
                        <span>📁</span> Exportar Dados do Fogão
                    </button>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">Dados Históricos</div>
                        <button class="export-btn" id="exportBtn">
                            <span>📁</span> Exportar Dados
                        </button>
                    </div>

                    <div class="tab-container">
                        <div class="tab active" data-tab="table">Tabela</div>
                        <div class="tab" data-tab="stats">Estatísticas</div>
                        <div class="tab" data-tab="logs">Registros</div>
                    </div>

                    <div class="tab-content active" id="tableTab">
                        <div class="history-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Valor (ppm)</th>
                                        <th>Status</th>
                                        <th>Fogão</th>
                                        <th>Duração</th>
                                        <th>Válvula</th>
                                        <th>Conexão</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable">
                                    <!-- Dados serão inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-content" id="statsTab">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-title">Máxima Registrada</div>
                                <div class="stat-value" id="maxValue">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">Mínima Registrada</div>
                                <div class="stat-value" id="minValue">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">Média</div>
                                <div class="stat-value" id="avgValue">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-title">Total de Leituras</div>
                                <div class="stat-value" id="totalReadings">0</div>
                            </div>
                        </div>

                        <div class="panel-title">Distribuição de Status</div>
                        <div style="margin: 1.5rem 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Normal: <span id="normalCount">0</span></span>
                                <span style="color: var(--warning)">Aviso: <span id="warningCount">0</span></span>
                                <span style="color: var(--error)">Perigo: <span id="dangerCount">0</span></span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" id="statusProgress" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="logsTab">
                        <div class="history-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Evento</th>
                                        <th>Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTable">
                                    <!-- Logs serão inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toastAlert">
            ALERTA: Nível de gás perigoso detectado!
        </div>
    </div>

    <script type="module">
        // Configurações (ajustadas para tempos mais rápidos)
        const ALERT_THRESHOLD = 300;
        const WARNING_THRESHOLD = 150;
        const UPDATE_INTERVAL = 500;
        const MAX_HISTORY = 50;
        const WAVEFORM_BARS = 30;
        const MAX_DATA_POINTS = 30;
        const CHART_UPDATE_INTERVAL = 1000;
        const HISTORY_UPDATE_INTERVAL = 3000;
        const CONNECTION_TIMEOUT = 30000;

        // Conexão Supabase com configurações otimizadas
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabaseUrl = 'https://hklypgeglqifzzxdmlfq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhrbHlwZ2VnbHFpZnp6eGRtbGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUxODY5NTYsImV4cCI6MjA2MDc2Mjk1Nn0.8dqdDNJ2t5YvvTHmy167vUOqrXOnDNOhgmwLf_0YmvQ';
        
        const supabase = createClient(supabaseUrl, supabaseKey, {
            realtime: {
                params: {
                    eventsPerSecond: 20,
                    heartbeatInterval: 5000,
                }
            }
        });

        // Variáveis globais
        let gasChart, flameHistoryChart;
        let dataHistory = [];
        let eventLogs = [];
        let alertCount = 0;
        let waveformData = Array(WAVEFORM_BARS).fill(0);
        let isAlarmMuted = false;
        let startTime = Date.now();
        let deviceId = null;
        let realtimeChannel = null;
        let isValveOpen = false;
        let currentUser = null;
        let lastDataUpdate = 0;
        let connectionType = 'desconectado';
        let lastChartUpdate = 0;
        let dataUpdateQueue = [];
        let isProcessingQueue = false;
        let flameStartTime = 0;
        let totalFlameTimeToday = 0;

        // Elementos DOM
        const loginScreen = document.getElementById('loginScreen');
        const mainScreen = document.getElementById('mainScreen');
        const userAvatar = document.getElementById('userAvatar');
        const userDropdown = document.getElementById('userDropdown');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const connectionStatus = document.getElementById('connectionStatus');
        const gasValueElement = document.getElementById('gasValue');
        const gasStatus = document.getElementById('gasStatus');
        const historyTable = document.getElementById('historyTable');
        const toastAlert = document.getElementById('toastAlert');
        const alertCountElement = document.getElementById('alertCount');
        const exportBtn = document.getElementById('exportBtn');
        const maxValue = document.getElementById('maxValue');
        const minValue = document.getElementById('minValue');
        const avgValue = document.getElementById('avgValue');
        const totalReadings = document.getElementById('totalReadings');
        const normalCount = document.getElementById('normalCount');
        const warningCount = document.getElementById('warningCount');
        const dangerCount = document.getElementById('dangerCount');
        const statusProgress = document.getElementById('statusProgress');
        const logsTable = document.getElementById('logsTable');
        const waveformContainer = document.getElementById('waveformContainer');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetZoomBtn = document.getElementById('resetZoomBtn');
        const currentStatusIcon = document.getElementById('currentStatusIcon');
        const readingsCount = document.getElementById('readingsCount');
        const uptimeText = document.getElementById('uptimeText');
        const muteAlarmBtn = document.getElementById('muteAlarmBtn');
        const alarmControls = document.getElementById('alarmControls');
        const flameStateStatus = document.getElementById('flameStateStatus');
        const currentFlameTime = document.getElementById('currentFlameTime');
        const totalFlameTime = document.getElementById('totalFlameTime');
        const flameProgress = document.getElementById('flameProgress');
        const flameAlert = document.getElementById('flameAlert');
        const alertThresholdMinutes = document.getElementById('alertThresholdMinutes');
        const dailyLimitLabel = document.getElementById('dailyLimitLabel');
        const maxUsageInput = document.getElementById('maxUsageInput');
        const dailyMaxInput = document.getElementById('dailyMaxInput');
        const saveFlameSettings = document.getElementById('saveFlameSettings');
        const exportFlameData = document.getElementById('exportFlameData');
        const resetFlameTimeBtn = document.getElementById('resetFlameTimeBtn');
        const gpsLocation = document.getElementById('gpsLocation');
        const valveControlBtn = document.getElementById('valveControlBtn');
        const valveStatusText = document.getElementById('valveStatusText');
        const connectionTypeIcon = document.getElementById('connectionTypeIcon');
        const connectionTypeText = document.getElementById('connectionTypeText');
        const loginFormElement = document.getElementById('loginFormElement');
        const registerFormElement = document.getElementById('registerFormElement');
        const forgotPasswordFormElement = document.getElementById('forgotPasswordFormElement');
        const resetPasswordFormElement = document.getElementById('resetPasswordFormElement');
        const showRegisterLink = document.getElementById('showRegisterLink');
        const showLoginLink = document.getElementById('showLoginLink');
        const showLoginLink2 = document.getElementById('showLoginLink2');
        const showLoginLink3 = document.getElementById('showLoginLink3');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const notificationBell = document.getElementById('notificationBell');
        const profileBtn = document.getElementById('profileBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBtn = document.getElementById('loginBtn');
        const loginSpinner = document.getElementById('loginSpinner');
        const registerBtn = document.getElementById('registerBtn');
        const registerSpinner = document.getElementById('registerSpinner');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const forgotPasswordSpinner = document.getElementById('forgotPasswordSpinner');
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        const resetPasswordSpinner = document.getElementById('resetPasswordSpinner');
        const resetSuccessMessage = document.getElementById('resetSuccessMessage');
        const resetToken = document.getElementById('resetToken');

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            await initAuth();
            initCharts();
            initWaveform();
            setupEventListeners();
            updateUptime();
            
            // Atualizações mais frequentes
            setInterval(updateUptime, 500);
            setInterval(checkConnectionStatus, 5000);
            setInterval(processDataQueue, 100);
            setInterval(updateFlameTime, 1000);
        });

        // Função para atualizar o estado da válvula na interface
        function updateValveUI(state) {
            isValveOpen = state;
            if (valveControlBtn) {
                if (state) {
                    valveControlBtn.className = "btn-valve btn-valve-open";
                    valveControlBtn.innerHTML = "Fechar Válvula";
                    if (valveStatusText) valveStatusText.textContent = "Válvula aberta - Gás fluindo";
                } else {
                    valveControlBtn.className = "btn-valve btn-valve-closed";
                    valveControlBtn.innerHTML = "Abrir Válvula";
                    if (valveStatusText) valveStatusText.textContent = "Válvula fechada - Gás bloqueado";
                }
            }
        }

        // Função para atualizar o tempo do fogão
        function updateFlameTime() {
            if (flameStartTime > 0) {
                const currentTime = Math.floor((Date.now() - flameStartTime) / 1000);
                currentFlameTime.textContent = formatTime(currentTime);
                
                const totalTime = totalFlameTimeToday + currentTime;
                totalFlameTime.textContent = formatTime(totalTime);
                
                const hoursUsed = totalTime / 3600;
                const dailyLimit = parseInt(dailyMaxInput.value) || 8;
                const progressPercent = Math.min(100, (hoursUsed / dailyLimit) * 100);
                flameProgress.style.width = `${progressPercent}%`;
                
                const alertThreshold = parseInt(maxUsageInput.value) || 60;
                if (currentTime > alertThreshold * 60) {
                    flameAlert.style.display = "block";
                } else {
                    flameAlert.style.display = "none";
                }
            }
        }

        // Função para processar fila de dados
        async function processDataQueue() {
            if (isProcessingQueue || dataUpdateQueue.length === 0) return;
            
            isProcessingQueue = true;
            
            const itemsToProcess = dataUpdateQueue.splice(0, 5);
            for (const data of itemsToProcess) {
                await updateGasData(data);
            }
            
            isProcessingQueue = false;
            
            if (dataUpdateQueue.length > 0) {
                setTimeout(processDataQueue, 0);
            }
        }

        // Inicializa autenticação com Supabase
        async function initAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (session) {
                    currentUser = session.user;
                    showMainScreen(session.user);
                    await initRealtimeConnection();
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                console.error('Erro na autenticação:', error);
                showLoginScreen();
            }
        }

        // Inicializa conexão em tempo real
        async function initRealtimeConnection() {
            if (!currentUser) return;
          
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
            }
          
            try {
                const { data: devices, error: devicesError } = await supabase
                    .from('devices')
                    .select('device_id')
                    .eq('user_id', currentUser.id)
                    .limit(1);
              
                if (devicesError) throw devicesError;
              
                if (!devices || devices.length === 0) {
                    showNotification("Configuração", "Nenhum dispositivo vinculado à sua conta");
                    return;
                }
              
                deviceId = devices[0].device_id;
              
                await Promise.all([
                    loadHistoryData(),
                    loadDeviceSettings()
                ]);
              
                subscribeToDevice();
                checkConnectionStatus();
                updateUserInfo();
              
            } catch (error) {
                console.error('Erro na conexão:', error);
                showNotification("Erro", "Falha na conexão com o dispositivo");
            }
        }

        // Carrega configurações do dispositivo
        async function loadDeviceSettings() {
            try {
                if (!deviceId) return;
                
                const { data: settings, error } = await supabase
                    .from('devices')
                    .select('*')
                    .eq('device_id', deviceId)
                    .single();
                
                if (error) throw error;
                
                if (settings) {
                    maxUsageInput.value = settings.alert_threshold / 60 || 60;
                    dailyMaxInput.value = settings.daily_limit / 3600 || 8;
                    dailyLimitLabel.textContent = `${dailyMaxInput.value}h máximo`;
                    console.log("Configurações do dispositivo carregadas:", settings);
                    return settings;
                }
                
            } catch (error) {
                console.error("Erro ao carregar configurações:", error);
                maxUsageInput.value = 60;
                dailyMaxInput.value = 8;
                dailyLimitLabel.textContent = "8h máximo";
            }
        }

        // Assina canal do dispositivo
        function subscribeToDevice() {
            if (!deviceId) return;
            
            realtimeChannel = supabase
                .channel(`realtime:${deviceId}`)
                .on('postgres_changes', { 
                    event: 'INSERT',
                    schema: 'public',
                    table: 'readings',
                    filter: `device_id=eq.${deviceId}`
                }, payload => {
                    lastDataUpdate = Date.now();
                    dataUpdateQueue.push(payload.new);
                })
                .on('broadcast', { event: 'sensor_data' }, payload => {
                    lastDataUpdate = Date.now();
                    dataUpdateQueue.push(payload.payload);
                })
                .on('broadcast', { event: 'command_response' }, payload => {
                    showNotification("Resposta", payload.payload.message);
                })
                .on('broadcast', { event: 'valve_state' }, payload => {
                    updateValveUI(payload.payload.state === "open");
                })
                .on('broadcast', { event: 'flame_state' }, payload => {
                    updateFlameState(payload.payload.state, payload.payload.start_time);
                })
                .on('broadcast', { event: 'log' }, payload => {
                    addToLogs(payload.payload);
                })
                .subscribe((status, err) => {
                    if (err) {
                        console.error('Erro na assinatura:', err);
                        updateConnectionStatus(false);
                    } else {
                        updateConnectionStatus(true);
                    }
                });
        }

        // Atualiza estado do fogão
        function updateFlameState(state, startTime = null) {
            if (state) {
                flameStateStatus.textContent = "LIGADO";
                flameStateStatus.className = "gas-status status-warning";
                flameStartTime = startTime ? new Date(startTime).getTime() : Date.now();
            } else {
                flameStateStatus.textContent = "DESLIGADO";
                flameStateStatus.className = "gas-status status-normal";
                if (flameStartTime > 0) {
                    const sessionTime = Math.floor((Date.now() - flameStartTime) / 1000);
                    totalFlameTimeToday += sessionTime;
                    flameStartTime = 0;
                }
            }
        }

        // Envia comando para o dispositivo
        function sendDeviceCommand(command, parameter = null) {
            if (!realtimeChannel || !deviceId) return;

            realtimeChannel.send({
                type: 'broadcast',
                event: 'remote_command',
                payload: {
                    command: command,
                    parameter: parameter,
                    timestamp: new Date().toISOString()
                }
            });
        }

        // Atualiza dados do gás na interface
        async function updateGasData(data) {
            if (!data) return;
            
            try {
                connectionType = data.connection_type || "desconhecido";
                lastDataUpdate = Date.now();
                
                const sensorValue = parseInt(data.gas_value || data.gas || 0);
                
                gasValueElement.textContent = sensorValue;
                
                let status, statusClass, statusIcon;
                if (sensorValue > ALERT_THRESHOLD) {
                    status = "PERIGO";
                    statusClass = "status-danger";
                    statusIcon = "🚨";
                    if (!isAlarmMuted) triggerAlarm();
                } else if (sensorValue > WARNING_THRESHOLD) {
                    status = "AVISO";
                    statusClass = "status-warning";
                    statusIcon = "⚠️";
                } else {
                    status = "NORMAL";
                    statusClass = "status-normal";
                    statusIcon = "✅";
                }
                
                gasStatus.textContent = status;
                gasStatus.className = `gas-status ${statusClass}`;
                currentStatusIcon.textContent = statusIcon;
                
                if (data.flame_state !== undefined) {
                    updateFlameState(data.flame_state, data.flame_start_time);
                }
                
                if (data.valve_state !== undefined) {
                    updateValveUI(data.valve_state === "open");
                }
                
                if (data.connection_type) {
                    connectionType = data.connection_type;
                    connectionTypeText.textContent = data.connection_type === 'mobile' ? 'Dados Móveis' : 'WiFi';
                    connectionTypeIcon.textContent = data.connection_type === 'mobile' ? '📡' : '📶';
                }
                
                if (data.gps_location) {
                    gpsLocation.innerHTML = `<a href="https://www.google.com/maps?q=${data.gps_location}" target="_blank">Ver no mapa</a>`;
                }

                requestAnimationFrame(() => {
                    updateWaveform(sensorValue);
                    updateCharts(sensorValue);
                    updateHistory(data);
                    updateCounters(sensorValue);
                });
                
            } catch (error) {
                console.error('Erro ao atualizar dados:', error);
            }
        }

        // Verifica status da conexão
        function checkConnectionStatus() {
            if (!realtimeChannel || !deviceId) {
                connectionStatus.className = "connection-status status-disconnected";
                connectionStatus.querySelector('span').textContent = "Dispositivo não vinculado";
                connectionStatus.querySelector('.status-indicator').className = "status-indicator indicator-disconnected";
                return;
            }

            const isConnected = (Date.now() - lastDataUpdate) < CONNECTION_TIMEOUT;
            
            if (isConnected) {
                connectionStatus.className = "connection-status status-connected";
                connectionStatus.querySelector('span').textContent = `Conectado via ${connectionType}`;
                connectionStatus.querySelector('.status-indicator').className = "status-indicator indicator-connected";
            } else {
                connectionStatus.className = "connection-status status-disconnected";
                connectionStatus.querySelector('span').textContent = "Dispositivo Offline";
                connectionStatus.querySelector('.status-indicator').className = "status-indicator indicator-disconnected";
            }
        }

        // Formata tempo em HH:MM:SS
        function formatTime(seconds) {
            seconds = Math.max(0, parseInt(seconds));
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Atualiza tempo de atividade
        function updateUptime() {
            const now = Date.now();
            const uptimeSeconds = Math.floor((now - startTime) / 1000);
            uptimeText.textContent = formatTime(uptimeSeconds);
        }

        // Carrega dados históricos
        async function loadHistoryData() {
            try {
                const { data, error } = await supabase
                    .from('readings')
                    .select('*')
                    .eq('device_id', deviceId)
                    .order('timestamp', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    dataHistory = data.map(item => ({
                        date: new Date(item.timestamp).toLocaleDateString(),
                        time: new Date(item.timestamp).toLocaleTimeString(),
                        value: item.gas_value,
                        status: getStatusLevel(item.gas_value),
                        flame: item.flame_state,
                        duration: item.flame_time || 0,
                        valve: item.valve_state === "open" ? "Aberta" : "Fechada",
                        connection: item.connection_type || "desconhecido"
                    }));
                    
                    requestAnimationFrame(() => {
                        updateHistoryTable();
                        updateCharts();
                        updateCounters();
                        updateGasData(data[0]);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                showNotification("Erro", "Falha ao carregar histórico");
            }
        }

        function getStatusLevel(value) {
            return value > ALERT_THRESHOLD ? "PERIGO" : 
                   value > WARNING_THRESHOLD ? "AVISO" : "NORMAL";
        }

        // Atualiza gráficos
        function updateCharts(gasValue) {
            const now = Date.now();
            
            if (gasChart.data.labels.length > MAX_DATA_POINTS) {
                gasChart.data.labels.shift();
                gasChart.data.datasets[0].data.shift();
            }
            
            if (gasValue !== undefined) {
                gasChart.data.labels.push(new Date().toLocaleTimeString());
                gasChart.data.datasets[0].data.push(gasValue);
            }
            
            if (now - lastChartUpdate > CHART_UPDATE_INTERVAL) {
                lastChartUpdate = now;
                gasChart.update('none');
                
                if (dataHistory.some(d => d.flame)) {
                    updateFlameHistoryChart();
                }
            }
        }

        // Atualiza gráfico de histórico do fogão
        function updateFlameHistoryChart() {
            const flameByDay = dataHistory.reduce((acc, curr) => {
                if (curr.flame) {
                    if (!acc[curr.date]) acc[curr.date] = 0;
                    acc[curr.date] += curr.duration / 60;
                }
                return acc;
            }, {});
            
            flameHistoryChart.data.labels = Object.keys(flameByDay);
            flameHistoryChart.data.datasets[0].data = Object.values(flameByDay);
            flameHistoryChart.update();
        }

        // Atualiza tabela de histórico
        function updateHistoryTable() {
            historyTable.innerHTML = dataHistory.slice(0, MAX_HISTORY).map(entry => {
                const rowClass = entry.value > ALERT_THRESHOLD ? 'danger-row' : 
                                entry.value > WARNING_THRESHOLD ? 'warning-row' : '';
                return `
                    <tr class="${rowClass}">
                        <td>${entry.date} ${entry.time}</td>
                        <td>${entry.value}</td>
                        <td>${entry.status}</td>
                        <td>${entry.flame ? 'Ligado' : 'Desligado'}</td>
                        <td>${formatTime(entry.duration)}</td>
                        <td>${entry.valve}</td>
                        <td>${entry.connection}</td>
                    </tr>
                `;
            }).join('');
        }

        // Atualiza contadores
        function updateCounters(gasValue) {
            const total = dataHistory.length;
            if (total === 0) return;
            
            const normal = dataHistory.filter(d => d.value <= WARNING_THRESHOLD).length;
            const warning = dataHistory.filter(d => d.value > WARNING_THRESHOLD && d.value <= ALERT_THRESHOLD).length;
            const danger = dataHistory.filter(d => d.value > ALERT_THRESHOLD).length;
            
            readingsCount.textContent = total;
            totalReadings.textContent = total;
            normalCount.textContent = normal;
            warningCount.textContent = warning;
            dangerCount.textContent = danger;
            
            const maxVal = Math.max(...dataHistory.slice(0, 100).map(d => d.value));
            const minVal = Math.min(...dataHistory.slice(0, 100).map(d => d.value));
            const avgVal = (dataHistory.slice(0, 100).reduce((sum, d) => sum + d.value, 0) / Math.min(total, 100)).toFixed(1);
            
            maxValue.textContent = maxVal;
            minValue.textContent = minVal;
            avgValue.textContent = avgVal;
            
            const normalPercent = (normal / total) * 100;
            const warningPercent = (warning / total) * 100;
            statusProgress.style.background = `linear-gradient(90deg, 
                var(--neon-green) 0%, 
                var(--neon-green) ${normalPercent}%, 
                var(--warning) ${normalPercent}%, 
                var(--warning) ${normalPercent + warningPercent}%, 
                var(--error) ${normalPercent + warningPercent}%, 
                var(--error) 100%)`;
        }

        // Inicializa gráficos
        function initCharts() {
            const ctx = document.getElementById('gasChart').getContext('2d');
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 255, 0, 0.3)');
            gradient.addColorStop(WARNING_THRESHOLD/500, 'rgba(255, 255, 0, 0.3)');
            gradient.addColorStop(ALERT_THRESHOLD/500, 'rgba(255, 0, 0, 0.3)');
            
            gasChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Nível de Gás (ppm)',
                        data: [],
                        borderColor: 'var(--neon-green)',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        annotation: {
                            annotations: {
                                warningLine: {
                                    type: 'line',
                                    yMin: WARNING_THRESHOLD,
                                    yMax: WARNING_THRESHOLD,
                                    borderColor: 'var(--warning)',
                                    borderWidth: 1,
                                    borderDash: [5, 5]
                                },
                                dangerLine: {
                                    type: 'line',
                                    yMin: ALERT_THRESHOLD,
                                    yMax: ALERT_THRESHOLD,
                                    borderColor: 'var(--error)',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: { enabled: false },
                                pinch: { enabled: false }
                            },
                            pan: { enabled: false }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, min: 0, max: 500 },
                        x: { display: false }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });

            // Gráfico de histórico do fogão
            const flameCtx = document.getElementById('flameHistoryChart').getContext('2d');
            flameHistoryChart = new Chart(flameCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tempo de Uso (minutos)',
                        data: [],
                        backgroundColor: 'rgba(255, 100, 100, 0.7)',
                        borderColor: 'rgba(255, 100, 100, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Inicializa visualização de forma de onda
        function initWaveform() {
            waveformContainer.innerHTML = '';
            for (let i = 0; i < WAVEFORM_BARS; i++) {
                const bar = document.createElement('div');
                bar.className = 'waveform-bar';
                bar.style.height = '0%';
                waveformContainer.appendChild(bar);
            }
        }

        // Atualiza forma de onda
        function updateWaveform(value) {
            waveformData.push(value);
            if (waveformData.length > WAVEFORM_BARS) {
                waveformData.shift();
            }
            
            const maxValue = 500;
            const bars = waveformContainer.querySelectorAll('.waveform-bar');
            
            waveformData.forEach((val, i) => {
                if (bars[i]) {
                    const heightPercent = Math.min(100, (val / maxValue) * 100);
                    bars[i].style.height = `${heightPercent}%`;
                    
                    if (val > ALERT_THRESHOLD) {
                        bars[i].className = 'waveform-bar danger';
                    } else if (val > WARNING_THRESHOLD) {
                        bars[i].className = 'waveform-bar warning';
                    } else {
                        bars[i].className = 'waveform-bar';
                    }
                }
            });
        }

        // Mostra notificação
        function showNotification(title, message) {
            toastAlert.textContent = `${title}: ${message}`;
            toastAlert.style.display = 'block';
            setTimeout(() => {
                toastAlert.style.display = 'none';
            }, 3000);
            
            alertCount++;
            alertCountElement.textContent = alertCount;
        }

        // Dispara alarme
        function triggerAlarm() {
            alarmControls.style.display = 'block';
            showNotification("ALERTA DE GÁS", "Nível perigoso detectado!");
            
            try {
                const alarmSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
                alarmSound.play();
            } catch (e) {
                console.log("Não foi possível tocar o alarme:", e);
            }
        }

        // Mostra tela principal
        function showMainScreen(user) {
            loginScreen.style.opacity = '0';
            loginScreen.style.transform = 'scale(0.95)';
            
            setTimeout(() => {
                loginScreen.style.display = 'none';
                mainScreen.style.display = 'flex';
                mainScreen.style.opacity = '0';
                
                if (user) {
                    updateUserInfo();
                }
                
                setTimeout(() => {
                    mainScreen.style.opacity = '1';
                    mainScreen.style.transform = 'scale(1)';
                }, 50);
            }, 300);
        }

        // Atualiza informações do usuário
        function updateUserInfo() {
            if (!currentUser) return;
            
            userName.textContent = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
            userEmail.textContent = currentUser.email;
            userAvatar.textContent = (currentUser.user_metadata?.full_name || currentUser.email).charAt(0).toUpperCase();
        }

        // Mostra tela de login
        function showLoginScreen() {
            loginScreen.style.display = 'block';
            mainScreen.style.display = 'none';
        }

        // Configura listeners de eventos
        function setupEventListeners() {
            // Configurar toggles de senha
            const togglePairs = [
                { toggle: 'toggleLoginPassword', input: 'loginPassword' },
                { toggle: 'toggleRegisterPassword', input: 'registerPassword' },
                { toggle: 'toggleRegisterConfirmPassword', input: 'registerConfirmPassword' },
                { toggle: 'toggleResetPassword', input: 'resetNewPassword' },
                { toggle: 'toggleResetConfirmPassword', input: 'resetConfirmPassword' }
            ];
            
            togglePairs.forEach(pair => {
                setupPasswordToggle(pair.toggle, pair.input);
            });
            
            // Links para alternar entre formulários
            showRegisterLink?.addEventListener('click', (e) => {
                e.preventDefault();
                switchForm(document.getElementById('registerForm'));
            });
            
            showLoginLink?.addEventListener('click', (e) => {
                e.preventDefault();
                switchForm(document.getElementById('loginForm'));
            });
            
            showLoginLink2?.addEventListener('click', (e) => {
                e.preventDefault();
                switchForm(document.getElementById('loginForm'));
            });
            
            showLoginLink3?.addEventListener('click', (e) => {
                e.preventDefault();
                switchForm(document.getElementById('loginForm'));
            });
            
            forgotPasswordLink?.addEventListener('click', (e) => {
                e.preventDefault();
                switchForm(document.getElementById('forgotPasswordForm'));
            });
            
            // Menu do usuário
            userAvatar?.addEventListener('click', () => {
                userDropdown.classList.toggle('show');
            });
            
            notificationBell?.addEventListener('click', () => {
                alertCount = 0;
                alertCountElement.textContent = '0';
            });
            
            // Fechar menu ao clicar fora
            window.addEventListener('click', (e) => {
                if (!e.target.matches('#userAvatar') && !e.target.matches('#notificationBell')) {
                    if (userDropdown?.classList?.contains('show')) {
                        userDropdown.classList.remove('show');
                    }
                }
            });
            
            // Logout
            logoutBtn?.addEventListener('click', async () => {
                const { error } = await supabase.auth.signOut();
                if (!error) {
                    window.location.reload();
                }
            });
            
            // Controle da válvula
            valveControlBtn?.addEventListener('click', toggleValve);
            
            // Controle do alarme
            muteAlarmBtn?.addEventListener('click', () => {
                if (isAlarmMuted) {
                    unmuteAlarm();
                } else {
                    muteAlarm();
                }
            });
            
            // Resetar tempo do fogão
            resetFlameTimeBtn?.addEventListener('click', () => {
                totalFlameTimeToday = 0;
                flameStartTime = 0;
                currentFlameTime.textContent = '00:00:00';
                totalFlameTime.textContent = '00:00:00';
                flameProgress.style.width = '0%';
                sendDeviceCommand("reset_stats");
                showNotification("Tempo Resetado", "O tempo diário foi zerado");
            });
            
            // Salvar configurações do fogão
            saveFlameSettings?.addEventListener('click', () => {
                const minutes = maxUsageInput.value;
                const hours = dailyMaxInput.value;
                sendDeviceCommand("set_flame_settings", { 
                    alert_threshold: minutes * 60,
                    daily_limit: hours * 3600 
                });
                dailyLimitLabel.textContent = `${hours}h máximo`;
                showNotification("Configurações", `Alerta após ${minutes} minutos e limite diário de ${hours} horas`);
            });
            
            // Exportar dados
            exportBtn?.addEventListener('click', exportData);
            exportFlameData?.addEventListener('click', exportFlameData);
            
            // Alternar entre abas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Configurar formulários
            setupAuthForms();
            
            // Configurar botões do gráfico
            zoomInBtn?.addEventListener('click', () => {
                gasChart.zoom(1.1);
            });
            
            zoomOutBtn?.addEventListener('click', () => {
                gasChart.zoom(0.9);
            });
            
            resetZoomBtn?.addEventListener('click', () => {
                gasChart.resetZoom();
            });
        }

        // Configura toggle de senha
        function setupPasswordToggle(toggleId, inputId) {
            const toggle = document.getElementById(toggleId);
            const input = document.getElementById(inputId);
            
            if (!toggle || !input) return;
            
            toggle.addEventListener('click', () => {
                if (input.type === 'password') {
                    input.type = 'text';
                    toggle.textContent = '👁️‍🗨️';
                } else {
                    input.type = 'password';
                    toggle.textContent = '👁️';
                }
            });
        }

        // Alterna entre formulários
        function switchForm(showForm) {
            const forms = document.querySelectorAll('.form-container');
            forms.forEach(form => {
                if (form === showForm) {
                    form.classList.remove('hidden');
                    setTimeout(() => {
                        form.style.opacity = '1';
                        form.style.transform = 'translateY(0) scale(1)';
                    }, 10);
                } else {
                    form.style.opacity = '0';
                    form.style.transform = 'translateY(20px) scale(0.95)';
                    setTimeout(() => {
                        form.classList.add('hidden');
                    }, 300);
                }
            });
        }

        // Alterna entre abas
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                if (content.id === `${tabId}Tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Configura formulários de autenticação
        function setupAuthForms() {
            // Formulário de login
            loginFormElement?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const emailError = document.getElementById('loginEmailError');
                const passwordError = document.getElementById('loginPasswordError');
                
                emailError.style.display = 'none';
                passwordError.style.display = 'none';
                
                if (!validateEmail(email)) {
                    emailError.style.display = 'block';
                    return;
                }
                
                loginBtn.disabled = true;
                loginSpinner.style.display = 'block';
                loginBtn.querySelector('span').textContent = 'Autenticando...';
                
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });
                    
                    if (error) {
                        throw error;
                    }
                    
                    currentUser = data.user;
                    showMainScreen(data.user);
                    initRealtimeConnection();
                } catch (error) {
                    passwordError.textContent = error.message;
                    passwordError.style.display = 'block';
                } finally {
                    loginBtn.disabled = false;
                    loginSpinner.style.display = 'none';
                    loginBtn.querySelector('span').textContent = 'Entrar';
                }
            });
            
            // Formulário de registro
            registerFormElement?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                
                const nameError = document.getElementById('registerNameError');
                const emailError = document.getElementById('registerEmailError');
                const passwordError = document.getElementById('registerPasswordError');
                const confirmPasswordError = document.getElementById('registerConfirmPasswordError');
                
                nameError.style.display = 'none';
                emailError.style.display = 'none';
                passwordError.style.display = 'none';
                confirmPasswordError.style.display = 'none';
                
                let isValid = true;
                
                if (name.trim() === '') {
                    nameError.style.display = 'block';
                    isValid = false;
                }
                
                if (!validateEmail(email)) {
                    emailError.style.display = 'block';
                    isValid = false;
                }
                
                if (password.length < 8) {
                    passwordError.style.display = 'block';
                    isValid = false;
                }
                
                if (password !== confirmPassword) {
                    confirmPasswordError.style.display = 'block';
                    isValid = false;
                }
                
                if (isValid) {
                    registerBtn.disabled = true;
                    registerSpinner.style.display = 'block';
                    registerBtn.querySelector('span').textContent = 'Criando conta...';
                    
                    try {
                        const { data, error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                data: {
                                    full_name: name
                                }
                            }
                        });
                        
                        if (error) {
                            throw error;
                        }
                        
                        alert('Conta criada com sucesso! Verifique seu e-mail para confirmar sua conta.');
                        switchForm(document.getElementById('loginForm'));
                        registerFormElement.reset();
                    } catch (error) {
                        emailError.textContent = error.message;
                        emailError.style.display = 'block';
                    } finally {
                        registerBtn.disabled = false;
                        registerSpinner.style.display = 'none';
                        registerBtn.querySelector('span').textContent = 'Cadastrar';
                    }
                }
            });
            
            // Formulário de recuperação de senha
            forgotPasswordFormElement?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('forgotEmail').value;
                const emailError = document.getElementById('forgotEmailError');
                
                emailError.style.display = 'none';
                
                if (!validateEmail(email)) {
                    emailError.style.display = 'block';
                    return;
                }
                
                forgotPasswordBtn.disabled = true;
                forgotPasswordSpinner.style.display = 'block';
                forgotPasswordBtn.querySelector('span').textContent = 'Enviando...';
                
                try {
                    const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin + '?token='
                    });
                    
                    if (error) {
                        throw error;
                    }
                    
                    alert(`Um link de recuperação foi enviado para ${email}`);
                    switchForm(document.getElementById('loginForm'));
                    forgotPasswordFormElement.reset();
                } catch (error) {
                    emailError.textContent = error.message;
                    emailError.style.display = 'block';
                } finally {
                    forgotPasswordBtn.disabled = false;
                    forgotPasswordSpinner.style.display = 'none';
                    forgotPasswordBtn.querySelector('span').textContent = 'Enviar Link';
                }
            });
            
            // Formulário de redefinição de senha
            resetPasswordFormElement?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const newPassword = document.getElementById('resetNewPassword').value;
                const confirmPassword = document.getElementById('resetConfirmPassword').value;
                const token = resetToken.value;
                
                const passwordError = document.getElementById('resetPasswordError');
                const confirmPasswordError = document.getElementById('resetConfirmPasswordError');
                
                passwordError.style.display = 'none';
                confirmPasswordError.style.display = 'none';
                
                let isValid = true;
                
                if (newPassword.length < 8) {
                    passwordError.textContent = 'A senha deve ter pelo menos 8 caracteres';
                    passwordError.style.display = 'block';
                    isValid = false;
                }
                
                if (newPassword !== confirmPassword) {
                    confirmPasswordError.textContent = 'As senhas não coincidem';
                    confirmPasswordError.style.display = 'block';
                    isValid = false;
                }
                
                if (isValid) {
                    resetPasswordBtn.disabled = true;
                    resetPasswordSpinner.style.display = 'block';
                    resetPasswordBtn.querySelector('span').textContent = 'Redefinindo...';
                    
                    try {
                        const { data, error } = await supabase.auth.updateUser({
                            password: newPassword
                        });
                        
                        if (error) {
                            throw error;
                        }
                        
                        resetSuccessMessage.classList.remove('hidden');
                        resetPasswordFormElement.style.opacity = '0.5';
                        resetPasswordFormElement.style.pointerEvents = 'none';
                        
                        setTimeout(() => {
                            window.location.href = window.location.pathname;
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Erro ao redefinir senha:', error);
                        passwordError.textContent = error.message.includes('invalid token') ? 
                            'Link de redefinição inválido ou expirado' : 
                            'Erro ao redefinir senha';
                        passwordError.style.display = 'block';
                    } finally {
                        resetPasswordBtn.disabled = false;
                        resetPasswordSpinner.style.display = 'none';
                        resetPasswordBtn.querySelector('span').textContent = 'Redefinir Senha';
                    }
                }
            });
            
            // Verificar token de redefinição na URL
            checkResetToken();
        }

        // Verifica token de redefinição na URL
        function checkResetToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                resetToken.value = token;
                switchForm(document.getElementById('resetPasswordForm'));
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Valida e-mail
        function validateEmail(email) {
            const re = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return re.test(String(email).toLowerCase());
        }

        // Funções adicionais para controle remoto
        function toggleValve() {
            sendDeviceCommand(isValveOpen ? "fechar_valvula" : "abrir_valvula");
        }

        function muteAlarm() {
            sendDeviceCommand("mute");
            isAlarmMuted = true;
            muteAlarmBtn.innerHTML = "🔈 Ativar Alarme";
            showNotification("Alarme", "Alarme silenciado");
        }

        function unmuteAlarm() {
            sendDeviceCommand("unmute");
            isAlarmMuted = false;
            muteAlarmBtn.innerHTML = "🔇 Silenciar Alarme";
            showNotification("Alarme", "Alarme ativado");
        }

        // Exporta dados
        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Data,Hora,Valor (ppm),Status,Fogão,Duração,Válvula,Conexão\n"
                + dataHistory.map(e => 
                    `"${e.date}","${e.time}",${e.value},"${e.status}","${e.flame ? 'Ligado' : 'Desligado'}",${e.duration},"${e.valve}","${e.connection}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "dados_gasmonitor.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

      

        // Adiciona logs ao histórico
        function addToLogs(log) {
            const now = new Date();
            const newLog = {
                date: now.toLocaleDateString(),
                time: now.toLocaleTimeString(),
                event: log.type,
                details: log.message
            };
            
            eventLogs.unshift(newLog);
            
            if (eventLogs.length > 50) {
                eventLogs.pop();
            }
            
            updateLogsTable();
        }

        // Atualiza tabela de logs
        function updateLogsTable() {
            logsTable.innerHTML = eventLogs.map(log => `
                <tr>
                    <td>${log.date} ${log.time}</td>
                    <td>${log.event}</td>
                    <td>${log.details}</td>
                </tr>
            `).join('');
        }

        // Atualiza histórico com novos dados
        function updateHistory(data) {
            const now = new Date();
            const newEntry = {
                date: now.toLocaleDateString(),
                time: now.toLocaleTimeString(),
                value: data.gas_value || data.gas || 0,
                status: (data.gas_value || data.gas || 0) > ALERT_THRESHOLD ? "PERIGO" : 
                       (data.gas_value || data.gas || 0) > WARNING_THRESHOLD ? "AVISO" : "NORMAL",
                flame: data.flame_state || false,
                duration: data.flame_time || 0,
                valve: data.valve_state === "open" ? "Aberta" : "Fechada",
                connection: data.connection_type || "desconhecido"
            };
            
            dataHistory.unshift(newEntry);
            
            if (dataHistory.length > 100) {
                dataHistory.pop();
            }
            
            updateHistoryTable();
        }

        // Atualiza status da conexão
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.className = "connection-status status-connected";
                connectionStatus.querySelector('span').textContent = "Dispositivo conectado";
                connectionStatus.querySelector('.status-indicator').className = "status-indicator indicator-connected";
            } else {
                connectionStatus.className = "connection-status status-disconnected";
                connectionStatus.querySelector('span').textContent = "Dispositivo desconectado";
                connectionStatus.querySelector('.status-indicator').className = "status-indicator indicator-disconnected";
            }
        }
    </script>
</body>
</html>